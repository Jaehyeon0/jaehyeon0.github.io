<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>jaehyeon0.github.io</title>
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        background: #1e1e1e;
        color: #ffffff;
      }
      #editor {
        height: 70vh;
        width: 100%;
      }
      #output {
        background: #252526;
        color: #9cdcfe;
        padding: 10px;
        font-family: monospace;
        white-space: pre-wrap;
        height: 30vh;
        overflow-y: auto;
      }
      button {
        background: #0e639c;
        color: white;
        border: none;
        padding: 10px 16px;
        font-size: 14px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div id="editor"></div>
    <button onclick="runCode()">▶ Run</button>
    <div id="output">Console Output:</div>

    <!-- FlareLane 스테이징 -->
    <h2>staging</h2>
    <script
      src="https://cdn.flarelane.com/WebSDK-staging.js"
      charset="UTF-8"
    ></script>
    <script>
      FlareLane.initialize({
        projectId: "75702d8e-71ba-4255-b17a-78ee5daa94c5",
      });
    </script>

    <!-- projdction -->
    <!-- <h2>production</h2> -->
    <!-- <script src="https://cdn.flarelane.com/WebSDK.js" charset="UTF-8"></script> -->
    <!-- <script> FlareLane.initialize({ projectId: "2290ab3c-e6c8-423a-9576-c54fba1d9da0" }); </script> -->

    <script src="https://unpkg.com/monaco-editor@0.34.1/min/vs/loader.js"></script>
    <script>
      require.config({
        paths: { vs: "https://unpkg.com/monaco-editor@0.34.1/min/vs" },
      });

      require(["vs/editor/editor.main"], function () {
        window.editor = monaco.editor.create(
          document.getElementById("editor"),
          {
            value: `// FlareLane.setUserId("user123")
// FlareLane.setTags({ gender: "men", age: 24 });
// FlareLane.setUserAttributes({
//   "name": "김철수",
//   "phoneNumber": "+821012341234",
//   "dob": "1992-03-01",
//   "email": "kevin@flarelane.com",
//   "country": "KR",
//   "language": "ko",
//   "timeZone": "Asia/Seoul"
// });
// FlareLane.trackEvent("click", { "key" : "value" })
// FlareLane.getDeviceId((deviceId) => {
//    // Do something...
//    console.log(deviceId);
// });
            `,
            language: "javascript",
            theme: "vs-dark",
            fontSize: 14,
          }
        );

        // FlareLane API 자동완성
        monaco.languages.registerCompletionItemProvider("javascript", {
          triggerCharacters: ["."],
          provideCompletionItems: function (model, position) {
            const textUntilPosition = model.getValueInRange({
              startLineNumber: position.lineNumber,
              startColumn: 1,
              endLineNumber: position.lineNumber,
              endColumn: position.column,
            });

            if (!/FlareLane\.$/.test(textUntilPosition.trim()))
              return { suggestions: [] };

            return {
              suggestions: [
                {
                  label: "setUserId",
                  kind: monaco.languages.CompletionItemKind.Function,
                  insertText: "setUserId(${1:userId})",
                  insertTextRules:
                    monaco.languages.CompletionItemInsertTextRule
                      .InsertAsSnippet,
                  documentation: "Sets the user ID",
                },
                {
                  label: "setTags",
                  kind: monaco.languages.CompletionItemKind.Function,
                  insertText: "setTags(${1:tags})",
                  insertTextRules:
                    monaco.languages.CompletionItemInsertTextRule
                      .InsertAsSnippet,
                  documentation: "Sets user tags",
                },
                {
                  label: "setUserAttributes",
                  kind: monaco.languages.CompletionItemKind.Function,
                  insertText: "setUserAttributes(${1:attributes})",
                  insertTextRules:
                    monaco.languages.CompletionItemInsertTextRule
                      .InsertAsSnippet,
                  documentation: "Sets user attributes",
                },
                {
                  label: "trackEvent",
                  kind: monaco.languages.CompletionItemKind.Function,
                  insertText: "trackEvent(${1:eventName}, ${2:eventData})",
                  insertTextRules:
                    monaco.languages.CompletionItemInsertTextRule
                      .InsertAsSnippet,
                  documentation: "Tracks a custom event with optional data",
                },
                {
                  label: "getDeviceId",
                  kind: monaco.languages.CompletionItemKind.Function,
                  insertText:
                    "getDeviceId((${1:deviceId}) => {\n  ${2:// Do something...}\n  console.log($1);\n})",
                  insertTextRules:
                    monaco.languages.CompletionItemInsertTextRule
                      .InsertAsSnippet,
                  documentation:
                    "Retrieves the current device ID via callback.",
                },
              ],
            };
          },
        });

        // Ctrl + Enter to run
        editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.Enter, () =>
          runCode()
        );
      });

      async function runCode() {
        const code = editor.getValue();
        const outputEl = document.getElementById("output");

        // 로그 영역 초기화
        outputEl.innerHTML = "";

        const originalLog = console.log;
        const originalError = console.error;

        // 로그 오버라이드
        console.log = (...args) => {
          const line = document.createElement("div");
          line.textContent = args.join(" ");
          line.style.color = "#9cdcfe";
          outputEl.appendChild(line);
          originalLog(...args);
        };

        console.error = (...args) => {
          const line = document.createElement("div");
          line.textContent = "Error: " + args.join(" ");
          line.style.color = "#f44747";
          line.style.fontWeight = "bold";
          outputEl.appendChild(line);
          originalError(...args);
        };

        try {
          const AsyncFunction = Object.getPrototypeOf(
            async function () {}
          ).constructor;
          const result = await new AsyncFunction(code)();

          if (result !== undefined) {
            const resultLine = document.createElement("div");
            resultLine.textContent = "Result: " + result;
            resultLine.style.color = "#4fc1ff";
            resultLine.style.fontWeight = "bold";
            outputEl.appendChild(resultLine);
          }

          // ⏳ 콜백 로그 기다릴 수 있게 잠깐 대기
          await new Promise((resolve) => setTimeout(resolve, 100)); // 필요에 따라 조정
        } catch (err) {
          const errorLine = document.createElement("div");
          errorLine.textContent = "Exception: " + err.message;
          errorLine.style.color = "#f44747";
          errorLine.style.fontWeight = "bold";
          outputEl.appendChild(errorLine);
        }

        // ❗ 로그 복구를 finally 대신 여기서 수행
        console.log = originalLog;
        console.error = originalError;
      }
    </script>
  </body>
</html>
